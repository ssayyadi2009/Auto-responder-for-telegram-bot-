from flask import Flask, request
import requests
import os

app = Flask(__name__)

BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise ValueError("BOT_TOKEN is not set in environment variables.")

# ูพุงู ุงุตู ุงููู /start
FIRST_MESSAGE = """ุณูุงู โ๏ธ
ุฎูุจุ ฺู ุฎุจุฑุ ๐
ูู ุฑุจุงุช @shervin_sayyadi2009 ูุณุชู ๐ค
ููุท ููุช ูุงุฒู ุจุงุดู ูุงู ฺฉูฺฉ ุฏุฑ ุญุงูุช ุนุงุฏ ูู ฺฉุงุฑุจุฑุฏ ุฏฺฏูโุง ูุฏุงุฑู โ"""

# ูพุงูโูุง ุฏูุนุงุช ุจุนุฏ /start
NEXT_MESSAGES = [
    "ุนู ๐ณ ุจุงุฒู /startุ!\nูู ฺฉู ุฎุงููุด ูุดุฏู ุจูุฏู ๐",
    "ู ุฑูู! ูฺฉุฑ ฺฉุฑุฏ ุจุง /start ุฑูุดู ูุดูุ\nูู ููุดู ุขูโูุงูู ๐",
    "ุจุงุฒ ุฒุฏ /startุ\nุจุงุจุง ูู ุขูุงุฏูโู ุงุฒ ูุจู ๐ค",
    "ุนูุ ูฺฏู ุฏูุนู ูพุด ุจุฏุฑููโุช ูฺฉุฑุฏูุ ๐ค",
    "/start ุฒุฏุ/n ุนู ุฏูุช ุจุฑุงู ุชูฺฏ ุดุฏู ๐",
    "ุจุงุฒู ุณูุงู ๐\nุณูุงูุง ูุจู ฺฉู ูุจูุฏุ",
    "ุนููู ๐ณ ูููุฒ ุงูุฌุงุ\nูู ูฺฉุฑ ฺฉุฑุฏู ุฑูุช!",
    "ุงููููู! ฺูุฏ ุจุงุฑ ูโุฎูุง ููู ุงุณุชุงุฑุช ฺฉูุ ๐",
    "ุฏุงุฏุงุด ูู ุฎูุฏฺฉุงุฑ ุฑูุดู ูุดูุ ูุงุฒู ูุณ ู ุงุณุชุงุฑุช ุจุฏ ๐",
    "ูฺฉุฑ ฺฉุฑุฏ ุจุงุชุฑ ุฏุงุฑู ฺฉู ุจุงุฏ ุฑูุดูู ฺฉูุ ๐คจ",
    "ุจุงูุฑ ฺฉู ูู Reset ููโุฎูุงู ๐",
    "ุงูู ฺูุฏูู ุจุงุฑ ุฒุฏุ\nุจุฐุงุฑ ู ุฏูุชุฑฺู ุจุงุฑู ุจุดูุฑู ๐๐",
    "ุจุงุดูุ ุงุณุชุงุฑุช ุดุฏู ุฏูุจุงุฑู!\nูู ุฎุจโฆ ุงุฒ ูุจู ุงุณุชุงุฑุช ุจูุฏู ๐",
    "/start ุฒุฏุ\nุฎุจ ูู ฺฉู ูููโุฌุง ุจูุฏู ๐",
    "ู ุฑูู! ุงุณุชุงุฑุช ุฒุฏ ุนู ุญูุตููโุช ุณุฑ ุฑูุชูุ ๐ค",
    "ุจุงุฒ ุณูุงู ฺฉุฑุฏุ\nุณูุงูู ูุจู ูููุฒ ฺฏุฑูู ๐",
    "ุนู!\nูฺฏู ุฎุงููุดู ฺฉุฑุฏู ุจูุฏุ ๐ค",
    "/start ูพุดุช /startุ\nูโุฎูุง ุฑฺฉูุฑุฏู ุจุฒููุ ๐",
    "ุณูุงู ุฏูุจุงุฑู ๐\nุงู ุฏฺฏู ฺูุฏูู ุจุงุฑูุ",
    "ูู ุญุณ ูโฺฉูู ุฏุงุฑ ููู ุชุณุช ูโฺฉู ๐",
    "ุจุงุฒู ุณูุงูุ ูู ุฎุณุชู ููโุดู ูู ุชู ฺุ ๐",
    "ููู! ุจุงุฒู ุงุณุชุงุฑุชุ\nุจุฐุงุฑ ููููโูู ุจุฎูุฑู ุจุนุฏ โโ",
    "ุจุงุฒ ุงููุฏุ\nุฎุจ ุฎูุด ุงููุฏ ุฏฺฏู โจ",
    "ุนู ุฏุงุฏุงุดุ ูู ฒด/ท ุฑูุดููุ ูุงุฒู ูุณ ุงุณุชุงุฑุช ุจุฒู ๐",
    "ุชู ุฑฺฉูุฑุฏ ุฒุฏ ุชู ุณูุงู ฺฉุฑุฏู ๐",
    "ู ุฑูุฒ ุจุฏูู ุงุณุชุงุฑุช ูู ุงูุชุญุงู ฺฉูุ\nููู ูุฏู ูููุฒ ุจุงุดู ๐",
    "ุจุงุดูุ ุฏูุจุงุฑู ุณูุงู!\nูู ุฏฺฏู ุชฺฉุฑุงุฑ ูุดู ูุง ๐"
]

# ูพุงูโูุง ุจุฑฺฏุดุช ุจุนุฏ ุงุฒ ุจูุงฺฉ ู ุขูุจูุงฺฉ
RETURN_MESSAGES = [
    "ุจุฑฺฏุดุชุ ูฺฉุฑ ฺฉุฑุฏ ุจุง ุจูุงฺฉ ููู ูุฑุงุฑ ุฏุงุฏุ ๐",
    "ูุงุงุง! ุจุฑฺฏุดุช! ุจูุงฺฉ ู ุขูุจูุงฺฉ ุดุฏูุช ู ุชุณุช ุดุฌุงุนุช ุจูุฏุ ๐",
    "ุนููู! ุจุฑฺฏุดุช ๐\nูู ฺฉู ููุดู ฺุดูุงู ุจูุช ุจูุฏ ๐",
    "ุจุงุฒ ุงููุฏุ\nูพุณ ุจูุงฺฉ ููุท ู ุญูู ฺฉูฺฺฉ ุจูุฏุ ููุ ๐",
    "ููู! ุจุฑฺฏุดุช!\nุฎุจ ุญุงูุง ุฏฺฏู ูโุฎูุง ฺฺฉุงุฑ ฺฉูุ ๐ค",
    "ุขูุง ุจุฑฺฏุดุช!\nูพุณ ุจูุงฺฉ ููุท ู ุงูุชุญุงู ฺฉูฺฺฉ ุจูุฏ ๐",
    "ุนู! ุฏูุจุงุฑู ุจุฑฺฏุดุช,\nูฺฉุฑ ฺฉุฑุฏ ุจุฏูู ูู ูโุชููุ ๐",
    "ุจุงุฒ ุงููุฏ!\nุฎุจ ุฎูุด ุงููุฏุ ุขูุงุฏูโู ูุงุณู ฺฏูพ ุฒุฏู ๐"
]

# ูุถุนุช ูุฑ ฺฉุงุฑุจุฑ
# {chat_id: {"index": n, "blocked": True/False, "return_index": m}}
user_data = {}

@app.route("/", methods=["POST"])
def webhook():
    data = request.get_json()
    if not data or "message" not in data:
        return "No message", 400

    chat_id = data["message"]["chat"]["id"]
    text = data["message"].get("text", "").strip()

    if text == "/start":
        info = user_data.get(chat_id, {"index": 0, "blocked": False, "return_index": 0})

        if info["blocked"]:
            # ูพุงู ุจุฑฺฏุดุช ฺุฑุฎูโุง
            msg_index = info["return_index"]
            send_message(chat_id, RETURN_MESSAGES[msg_index])
            info["return_index"] = (msg_index + 1) % len(RETURN_MESSAGES)
        else:
            if chat_id not in user_data:
                # ุงููู ุจุงุฑ โ ูพุงู ุงุตู
                send_message(chat_id, FIRST_MESSAGE)
            else:
                idx = info["index"]
                send_message(chat_id, NEXT_MESSAGES[idx])
                info["index"] = (idx + 1) % len(NEXT_MESSAGES)

        user_data[chat_id] = info

    return "OK", 200

def send_message(chat_id, text):
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    try:
        response = requests.post(url, json={"chat_id": chat_id, "text": text})
        if response.status_code == 200:
            return True
        else:
            # ุงฺฏุฑ ุจูุงฺฉ ุจูุฏ
            if "bot was blocked by the user" in response.text.lower():
                if chat_id in user_data:
                    user_data[chat_id]["blocked"] = True
            print("Telegram error:", response.text)
            return False
    except Exception as e:
        print("ุฎุทุง ุฏุฑ ุงุฑุณุงู ูพุงู:", e)
        return False

@app.route("/ping", methods=["GET"])
def ping():
    return "pong", 200

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 8080))
    app.run(host="0.0.0.0", port=port)

from flask import Flask, request
import requests
import os
import random

app = Flask(__name__)

BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise ValueError("BOT_TOKEN is not set in environment variables.")

FIRST_MESSAGE = """سلام ✌️
خوبی؟ چه خبر؟ 😎
من ربات @shervin_sayyadi2009 هستم 🤖
فقط وقتی لازم باشه میام کمک
در حالت عادی هم کاربرد دیگه‌ای ندارم ❌"""

NEXT_MESSAGES = [
"اوه اوه 😳 دوباره /start؟\nفکر کردم داری با روباه‌ها قهوه می‌خوری 🦊☕",
"هی رفیق! داری با /start هواپیمای کاغذی می‌فرستی؟ ✈️😂",
"عههه 😆 هنوز اینجایی؟\nفکر کردم داری با گربه‌ها پازل حل می‌کنی 🐱🧩",
"/start دوباره؟\nماموریت امروزت چیه؟ 🚀🎮",
"هی رفیق! داری رکورد /start میزنی یا دنبال موز هستی؟ 🍌😏",
"اووووف! دوباره /start؟\nفکر کردم داری با سفینه فضایی پرواز می‌کنی 🛸",
"داداش، من همیشه روشنم ولی هنوز قهوه‌ام سرد شده ☕😅",
"عههه 😳 داری با /start نقاشی سه‌بعدی می‌کنی؟ 🎨🖌️",
"اوه اوه! باز زدی /start؟\nفکر کردم داری ماموریت گنج پیدا می‌کنی 🏴‍☠️",
"هی رفیق! این چندمین بار استارت زدی؟\nفکر کنم داری مسابقه با ربات‌ها می‌دی 🤖",
"عه! فکر کردی من خاموشم؟ 😎",
"/start پشت /start؟\nداری با قورباغه‌ها مسابقه می‌دی 🐸🏁",
"اووووف! باز /start؟\nمن که هنوز اینجام، بیا با هم سفر کنیم 🌍",
"داداش، باز برگشتی؟\nفکر کردم امروز داری با ربات نینجا تمرین می‌کنی 🥷",
"هی رفیق! داری با /start قهوه و پیتزا همزمان می‌خوری؟ 🍕☕",
"باز استارت؟\nبذار اول موزم رو بخورم 🍌✋",
"عههه 😳 هنوز داری امتحان می‌کنی؟\nقول میدم چیزی منفجر نشه 😂",
"اووووف! دوباره /start؟\nفکر کنم داری با گربه‌ها چت می‌کنی 🐱💬",
"هی رفیق! داری با /start آهنگ جدید می‌سازی؟ 🎵🎧",
"/start پشت /start؟\nرکورد جهانی دست توئه 🏆",
"اوه اوه! باز زدی /start؟\nمن که هنوز اینجام 😏",
"داداش، بازم برگشتی؟\nفکر کردم امروز داری با اژدها پرواز می‌کنی 🐉",
"هی رفیق! داری با /start کیک درست می‌کنی؟ 🎂😆",
"باز زدی /start؟\nخب من که آماده‌ام 😎",
"/start پشت /start؟\nداری رکورد میزنی یا ماموریت فضایی؟ 🛸",
"هی رفیق! داری با دکمه استارت ستاره می‌سازی ✨",
"/start پشت /start؟\nداری با ربات‌های موزی مسابقه می‌دی 🍌🤖",
"/start پشت /start؟\nداری با روباه‌ها مسابقه می‌دی 🦊🏁",
"هی رفیق! داری بازی درمیاری با /start؟ 🎮",
"/start پشت /start؟\nداری رکورد میزنی 🚀",
"هی رفیق! داری با دکمه استارت کل‌کل می‌کنی؟ 🤔",
"داداش، باز برگشتی؟\nقول بده آخری باشه 😅",
"اووووف! باز برگشتی؟ 😅",
"هی رفیق! این چندمین باره که /start می‌زنی؟ 🤨",
"باز سلام کردی؟\nسلام قبلی هنوز داغه 🌞",
"داداش من همیشه روشنم، لازم نیس امتحان کنی 🤖",
"عه! فکر کردی خاموش شدم؟ 😂",
"اوه اوه! باز زدی /start؟ 😬",
"داداش، امروز داری با سفینه پرواز می‌کنی 🛸",
"هی رفیق! داری با /start کلک می‌زنی یا بازی می‌کنی؟ 🎮",
"داداش، امروز داری با اژدها پرواز می‌کنی 🐉",
"هی رفیق! داری با /start کیک درست می‌کنی؟ 🎂",
"/start پشت /start؟\nرکورد جهانی دست توئه 🏆",
"هی رفیق! داری با /start آهنگ جدید می‌سازی؟ 🎵",
"اووووف! باز اومدی؟ 😎",
"باز استارت؟\nبذار اول موزم رو بخورم 🍌",
"/start دوباره؟\nماموریت امروزت چیه؟ 🚀",
"عههه 😆 هنوز اینجایی؟\nفکر کردم داری با گربه‌ها پازل حل می‌کنی 🐱",
"هی رفیق! داری با /start هواپیمای کاغذی می‌فرستی؟ ✈️",
"اوه اوه 😳 دوباره /start؟\nفکر کردم داری با روباه‌ها قهوه می‌خوری 🦊☕",
"داداش، من همیشه روشنم ولی هنوز قهوه‌ام سرد شده ☕",
"عههه 😳 داری با /start نقاشی سه‌بعدی می‌کنی؟ 🎨",
"اوه اوه! باز زدی /start؟\nفکر کردم داری ماموریت گنج پیدا می‌کنی 🏴‍☠️",
"هی رفیق! این چندمین بار استارت زدی؟\nفکر کنم داری مسابقه با ربات‌ها می‌دی 🤖",
"/start پشت /start؟\nداری با قورباغه‌ها مسابقه می‌دی 🐸",
"اووووف! باز /start؟\nمن که هنوز اینجام، بیا با هم سفر کنیم 🌍",
"هی رفیق! داری با /start قهوه و پیتزا همزمان می‌خوری؟ 🍕☕",
"داداش، باز برگشتی؟\nفکر کردم امروز داری با ربات نینجا تمرین می‌کنی 🥷",
"عههه 😳 هنوز داری امتحان می‌کنی؟\nقول میدم چیزی منفجر نشه 😂",
"هی رفیق! داری با دکمه استارت ستاره می‌سازی ✨",
"/start پشت /start؟\nداری با ربات‌های موزی مسابقه می‌دی 🍌🤖",
"هی رفیق! داری بازی درمیاری با /start؟ 🎮",
"هی رفیق! داری با دکمه استارت کل‌کل می‌کنی؟ 🤔",
"اووووف! باز برگشتی؟ 😅",
"هی رفیق! این چندمین باره که /start می‌زنی؟ 🤨",
"باز سلام کردی؟\nسلام قبلی هنوز داغه 🌞",
"داداش من همیشه روشنم، لازم نیس امتحان کنی 🤖",
"عههه 😳 هنوز هم داری امتحان می‌کنی؟ 😅",
"اوه اوه! باز زدی /start؟\nمن که هنوز اینجام 😏",
"/start پشت /start؟\nرکورد جهانی دست توئه 🏆",
"عه! فکر کردی خاموش شدم؟ 😎",
"هی رفیق! داری با /start کیک درست می‌کنی؟ 🎂",
"هی رفیق! داری با /start آهنگ جدید می‌سازی؟ 🎵",
"هی رفیق! داری با /start قهوه و پیتزا همزمان می‌خوری؟ 🍕☕",
"هی رفیق! داری با /start کلک می‌زنی یا بازی می‌کنی؟ 🎮",
"هی رفیق! داری با /start هواپیمای کاغذی می‌فرستی؟ ✈️",
"اووووف! باز اومدی؟ 😎",
"عههه 😆 هنوز اینجایی؟\nفکر کردم داری با گربه‌ها پازل حل می‌کنی 🐱",
"اوه اوه 😳 دوباره /start؟\nفکر کردم داری با روباه‌ها قهوه می‌خوری 🦊☕",
"باز استارت؟\nبذار اول موزم رو بخورم 🍌✋",
"داداش، امروز داری با سفینه پرواز می‌کنی 🛸",
"داداش، امروز داری با اژدها پرواز می‌کنی 🐉",
"/start دوباره؟\nماموریت امروزت چیه؟ 🚀🎮",
"هی رفیق! داری بازی درمیاری با /start؟ 🎮",
"هی رفیق! داری با دکمه استارت ستاره می‌سازی ✨",
"/start پشت /start؟\nداری با روباه‌ها مسابقه می‌دی 🦊🏁",
"/start پشت /start؟\nداری با ربات‌های موزی مسابقه می‌دی 🍌🤖",
"/start پشت /start؟\nداری رکورد میزنی 🚀",
"/start پشت /start؟\nرکورد جهانی دست توئه 🏆",
"داداش من همیشه روشنم، لازم نیس امتحان کنی 🤖",
"اوه اوه! باز زدی /start؟ 😬",
"عههه 😳 هنوز هم داری امتحان می‌کنی؟ 😅",
"اووووف! دوباره /start؟\nفکر کنم داری با گربه‌ها چت می‌کنی 🐱💬",
"هی رفیق! این چندمین بار استارت زدی؟\nفکر کنم داری مسابقه با ربات‌ها می‌دی 🤖",
"هی رفیق! این چندمین باره که /start می‌زنی؟ 🤨",
"باز سلام کردی؟\nسلام قبلی هنوز گرمه 🌞",
"هی رفیق! داری با /start کلک می‌زنی یا بازی می‌کنی؟ 🎮",
"عه! فکر کردی خاموش شدم؟ 😂",
"هی رفیق! داری با /start قهوه و پیتزا همزمان می‌خوری؟ 🍕"
]

# وضعیت هر کاربر
# {chat_id: {"available_indexes": [0,1,2...], "used_indexes": []}}
user_data = {}

@app.route("/", methods=["POST"])
def webhook():
    data = request.get_json()
    if not data or "message" not in data:
        return "No message", 400

    chat_id = data["message"]["chat"]["id"]
    text = data["message"].get("text", "").strip()

    if text == "/start":
        info = user_data.get(chat_id)
        if not info:
            # اولین بار
            user_data[chat_id] = {
                "available_indexes": list(range(len(NEXT_MESSAGES))),
                "used_indexes": []
            }
            send_message(chat_id, FIRST_MESSAGE)
        else:
            available = info["available_indexes"]
            used = info["used_indexes"]
            if not available:
                # همه پیام‌ها استفاده شده → ریست
                available = list(range(len(NEXT_MESSAGES)))
                used = []
            idx = random.choice(available)
            available.remove(idx)
            used.append(idx)
            send_message(chat_id, NEXT_MESSAGES[idx])
            # بروزرسانی
            user_data[chat_id]["available_indexes"] = available
            user_data[chat_id]["used_indexes"] = used

    return "OK", 200

def send_message(chat_id, text):
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    try:
        response = requests.post(url, json={"chat_id": chat_id, "text": text})
        if response.status_code == 200:
            return True
        else:
            print("Telegram error:", response.text)
            return False
    except Exception as e:
        print("خطا در ارسال پیام:", e)
        return False

@app.route("/ping", methods=["GET"])
def ping():
    return "pong", 200

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 8080))
    app.run(host="0.0.0.0", port=port)
